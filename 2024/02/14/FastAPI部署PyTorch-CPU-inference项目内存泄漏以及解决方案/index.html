<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>FastAPI部署PyTorch CPU inference项目内存泄漏以及解决方案 - 甲醛的小屋</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Carbene Hu"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Carbene Hu"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="起因 最近需要在一个2c4g的一个服务器上做VITS-fast-finetuning项目的边缘部署，VITS算一个不大不小的模型，实测下来服务器的内存只有3.6G，刨开乱七八糟的服务也就只剩下少得可怜的2G左右内存可用，因此需要相当地精打细算才能得到比较好的效果。 前端没啥好说的，自己和copilot合作了一下撸了一个又不是不能用的，之后就轮到重量级的后端登场了。 还在漏还在漏 首先我们的需求和一"><meta property="og:type" content="blog"><meta property="og:title" content="FastAPI部署PyTorch CPU inference项目内存泄漏以及解决方案"><meta property="og:url" content="https://hyiker.github.io/2024/02/14/FastAPI%E9%83%A8%E7%BD%B2PyTorch-CPU-inference%E9%A1%B9%E7%9B%AE%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E4%BB%A5%E5%8F%8A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/"><meta property="og:site_name" content="甲醛的小屋"><meta property="og:description" content="起因 最近需要在一个2c4g的一个服务器上做VITS-fast-finetuning项目的边缘部署，VITS算一个不大不小的模型，实测下来服务器的内存只有3.6G，刨开乱七八糟的服务也就只剩下少得可怜的2G左右内存可用，因此需要相当地精打细算才能得到比较好的效果。 前端没啥好说的，自己和copilot合作了一下撸了一个又不是不能用的，之后就轮到重量级的后端登场了。 还在漏还在漏 首先我们的需求和一"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://img.byr.cool/i/2024/02/14/65cca9b57836b.webp"><meta property="og:image" content="https://img.byr.cool/i/2024/02/14/65ccaa286eb6b.webp"><meta property="og:image" content="https://img.byr.cool/i/2024/02/14/65ccaaa80dcc4.webp"><meta property="article:published_time" content="2024-02-14T19:29:38.000Z"><meta property="article:modified_time" content="2024-12-27T03:28:59.262Z"><meta property="article:author" content="Carbene Hu"><meta property="article:tag" content="FastAPI"><meta property="article:tag" content="PyTorch"><meta property="article:tag" content="内存泄漏"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://img.byr.cool/i/2024/02/14/65cca9b57836b.webp"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://hyiker.github.io/2024/02/14/FastAPI%E9%83%A8%E7%BD%B2PyTorch-CPU-inference%E9%A1%B9%E7%9B%AE%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E4%BB%A5%E5%8F%8A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/"},"headline":"FastAPI部署PyTorch CPU inference项目内存泄漏以及解决方案","image":["https://img.byr.cool/i/2024/02/14/65cca9b57836b.webp","https://img.byr.cool/i/2024/02/14/65ccaa286eb6b.webp","https://img.byr.cool/i/2024/02/14/65ccaaa80dcc4.webp"],"datePublished":"2024-02-14T19:29:38.000Z","dateModified":"2024-12-27T03:28:59.262Z","author":{"@type":"Person","name":"Carbene Hu"},"publisher":{"@type":"Organization","name":"甲醛的小屋","logo":{"@type":"ImageObject","url":{"light":"https://s4.ax1x.com/2021/12/30/TR2810.png","dark":"https://s1.ax1x.com/2022/04/03/q7u93t.png"}}},"description":"起因 最近需要在一个2c4g的一个服务器上做VITS-fast-finetuning项目的边缘部署，VITS算一个不大不小的模型，实测下来服务器的内存只有3.6G，刨开乱七八糟的服务也就只剩下少得可怜的2G左右内存可用，因此需要相当地精打细算才能得到比较好的效果。 前端没啥好说的，自己和copilot合作了一下撸了一个又不是不能用的，之后就轮到重量级的后端登场了。 还在漏还在漏 首先我们的需求和一"}</script><link rel="canonical" href="https://hyiker.github.io/2024/02/14/FastAPI%E9%83%A8%E7%BD%B2PyTorch-CPU-inference%E9%A1%B9%E7%9B%AE%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E4%BB%A5%E5%8F%8A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/github.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><!--!--><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-3-column"><script type="text/javascript" src="/js/imaegoo/night.js"></script><canvas id="universe"></canvas><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img class="logo-img" src="https://s4.ax1x.com/2021/12/30/TR2810.png" alt="甲醛的小屋" height="28"><img class="logo-img-dark" src="https://s1.ax1x.com/2022/04/03/q7u93t.png" alt="甲醛的小屋" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/resources">Resources</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Follow me on GitHub" href="https://github.com/Hyiker"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2024-02-14T19:29:38.000Z" title="2/14/2024, 7:29:38 PM">2024-02-14</time>发表</span><span class="level-item"><time dateTime="2024-12-27T03:28:59.262Z" title="12/27/2024, 3:28:59 AM">2024-12-27</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%BC%96%E7%A8%8B/">编程</a><span> / </span><a class="link-muted" href="/categories/%E7%BC%96%E7%A8%8B/Misc/">Misc</a></span><span class="level-item">10 分钟读完 (大约1446个字)</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title title-prefix is-3 is-size-4-mobile">FastAPI部署PyTorch CPU inference项目内存泄漏以及解决方案</h1><div class="content"><h2 id="起因">起因</h2>
<p>最近需要在一个2c4g的一个服务器上做<a target="_blank" rel="noopener" href="https://github.com/Plachtaa/VITS-fast-fine-tuning">VITS-fast-finetuning</a>项目的<del>边缘</del>部署，VITS算一个不大不小的模型，实测下来服务器的内存只有3.6G，刨开乱七八糟的服务也就只剩下少得可怜的2G左右内存可用，因此需要相当地精打细算才能得到比较好的效果。</p>
<p>前端没啥好说的，自己和copilot合作了一下撸了一个又不是不能用的，之后就轮到重量级的后端登场了。</p>
<h2 id="还在漏还在漏">还在漏还在漏</h2>
<p>首先我们的需求和一些现实情况如下：</p>
<ol type="1">
<li>服务器的内存和CPU资源都相当吃紧，基本每一次TTS请求都能把两核的CPU吃满</li>
<li>我希望每一次请求响应都够快，最简单的解决办法就是对模型（tts_fn）进行caching，相应的需要trade off一些内存</li>
<li>根据上一条需求，我们最好不要用subprocess来进行模型的推理，即使不考虑subprocess本身的开销，我们也不希望每一次请求都要重新加载模型</li>
</ol>
<p>需求对应的代码其实很简单，但是最后我使用<code>Gunicorn</code> + <code>Uvicorn worker</code> + <code>FastAPI</code>进行部署的时候出问题了：我手上有5个模型，但是只要请求数一多，整个服务器就会直接死掉，这是怎么会事呢？</p>
<p>首先我们刨掉几个模型，剩下三个，然后把worker给减到一个。发现运行几次之后，内存占用不停增长，直到把3.6G全部吃满，服务器没有响应，连SSH都会卡死（这里建议不要急，等个几分钟操作系统就会直接把内存清理掉）。</p>
<h3 id="问题定位">问题定位</h3>
<p>首先我们假设内存泄漏不出在VITS-fast-finetuning身上（实际上我检查了一遍也确实没有），一般来说简单的python web代码也没法写出内存泄漏的问题。使用开箱即用的<code>memory_profiler</code>进行内存分析：这个库提供了非常方便的<code>memory_profiler.profile</code>装饰器，可以直接在函数上使用，然后就可以得到函数单步的内存占用情况。</p>
<p>给每一个有嫌疑的函数都打上了<code>@profile</code>，发现问题出在了一个卷积层<code>Conv1D</code>上（偷懒图里不是同一次请求的调用栈，不过无伤大雅）：</p>
<p><img src="https://img.byr.cool/i/2024/02/14/65cca9b57836b.webp" /></p>
<p><img src="https://img.byr.cool/i/2024/02/14/65ccaa286eb6b.webp" /></p>
<p><img src="https://img.byr.cool/i/2024/02/14/65ccaaa80dcc4.webp" /></p>
<p>每个卷积层每次调用都会增加15-30M左右的内存占用，不幸的是模型中对该卷积层进行了循环调用，每一次请求下来整个服务器内存占用都会增加10M左右，在<code>htop</code>中查看也基本一致。</p>
<h3 id="漏水容易补水难">漏水容易补水难</h3>
<p>在进行profile之前我先上网搜了一下<code>FastAPI</code>+<code>Pytorch</code>+内存泄漏相关的问题，得到的答案无非是：</p>
<ul>
<li>这是worker内存的问题，使用<code>async</code>进行异步处理：实测对于我的问题没有任何帮助</li>
<li>使用<code>subprocess</code>进行模型推理：不符合需求，pass</li>
<li>使用<code>jemalloc</code>替代<code>glibc</code>：具体的方法是安装jemalloc并手动指定环境变量<code>LD_PRELOAD=LD_PRELOAD=/usr/lib/x86_64-linux-gnu/libjemalloc.so.2</code>，根据测试可以大幅减少内存的占用（在加载一个模型的时候总内存占用从3G+降低到了2.6G+左右），但是随着请求的增加，内存占用还是会不断增加，pass</li>
</ul>
<h3 id="解决方案">解决方案</h3>
<p>Damn, who knows! 在发现问题出在卷积层后，找到了这个issue：<a target="_blank" rel="noopener" href="https://github.com/pytorch/pytorch/issues/98688">Memory leak in Conv1d</a>，就是这个！这个issue在23年9月提出&amp;&amp;解决了，但是看样子服务器上的pytorch并没有实装这个fix，但是一个回复中提到了一个解决方案：</p>
<blockquote>
<p>When our validation team tried to reproduce it on CPU, all the to('cuda') has been changed to to('cpu'). As it is a case with dynamic shape inputs, the primitive and primitive description cache has made the memory increase at the beginning when it hasn't reached the maximum cache capacity size. By setting the below environment variables to decrease the cache capacity, the memory won't increase anymore: ONEDNN_PRIMITIVE_CACHE_CAPACITY=0 LRU_CACHE_CAPACITY=1</p>
</blockquote>
<p>设置这两个环境变量之后，内存占用果然不再增加，翻译成人话就是：</p>
<p>在动态shape的输入下，pytorch会缓存一些东西，primitive和primitive缓存会在未达到最大缓存大小的时候不断增加，通过设置这两个环境变量可以减少缓存的容量，使得内存占用不再增加直到服务器死掉。</p>
<h2 id="gunicorn哈哈没想到吧">Gunicorn：哈哈，没想到吧</h2>
<p>这个办法对于Uvicorn直接运行是生效的，但是我在服务器上直接跑了一个systemd service的gunicorn，前面说的东西在这玩意上一用上好像diao用没有，这是怎么会事呢？</p>
<p>探查后发现Gunicorn似乎不会老实地把自己的环境变量传递给worker子进程，需要在配置文件中手动指定：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">raw_env = [<span class="string">&quot;ONEDNN_PRIMITIVE_CACHE_CAPACITY=0&quot;</span>, <span class="string">&quot;LRU_CACHE_CAPACITY=1&quot;</span>, <span class="string">&quot;LD_PRELOAD=/usr/lib/x86_64-linux-gnu/libjemalloc.so.2&quot;</span>]</span><br></pre></td></tr></table></figure>
<p>And finally, its works fine.</p>
<h2 id="省流总结">省流总结</h2>
<p>设置环境变量<code>ONEDNN_PRIMITIVE_CACHE_CAPACITY=0</code>和<code>LRU_CACHE_CAPACITY=1</code>，可以减少pytorch的缓存容量，避免内存泄漏（伪），此外推荐使用<code>jemalloc</code>替代<code>glibc</code>，可以减少内存占用。</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>FastAPI部署PyTorch CPU inference项目内存泄漏以及解决方案</p><p><a href="https://hyiker.github.io/2024/02/14/FastAPI部署PyTorch-CPU-inference项目内存泄漏以及解决方案/">https://hyiker.github.io/2024/02/14/FastAPI部署PyTorch-CPU-inference项目内存泄漏以及解决方案/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>Carbene Hu</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2024-02-14</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2024-12-27</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/FastAPI/">FastAPI</a><a class="link-muted mr-2" rel="tag" href="/tags/PyTorch/">PyTorch</a><a class="link-muted mr-2" rel="tag" href="/tags/%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F/">内存泄漏</a></div><!--!--></article></div><!--!--><div class="card"><nav class="post-navigation mt-4 level is-mobile card-content"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2024/10/07/%E2%80%9C%E8%BF%99%E6%B8%B8%E6%88%8F%E9%83%BD%E6%98%AF%E8%B0%81%E5%9C%A8%E8%B5%A2%EF%BC%9F%E2%80%9D%EF%BC%9A%E6%89%BE%E5%88%B0%E5%90%88%E9%80%82%E7%9A%84%E7%AB%9E%E6%8A%80%E5%8C%B9%E9%85%8D%E6%A8%A1%E5%BC%8F/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">“这游戏都是谁在赢？”：找到合适的竞技匹配模式</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2023/12/17/%E4%B8%80%E6%AC%A1WSL%E4%B8%8A%E4%BD%BF%E7%94%A8clangd%E7%BC%96%E5%86%99cuda%E7%9A%84%E8%B8%A9%E5%9D%91/"><span class="level-item">一次WSL上使用clangd编写cuda的踩坑</span><i class="level-item fas fa-chevron-right"></i></a></div></nav></div><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div class="content" id="valine-thread"></div><script src="//cdn.jsdelivr.net/npm/leancloud-storage@3/dist/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine@1.4.16/dist/Valine.min.js"></script><script>new Valine({
            el: '#valine-thread',
            appId: "r0qA9mbjz4lWX92StwtatUSd-gzGzoHsz",
            appKey: "eqbjaQHLLgk5yUvAwzm7cFVn",
            placeholder: "来留言⑧~",
            
            avatarForce: false,
            meta: ["nick","mail","link"],
            pageSize: 10,
            lang: "zh-CN",
            visitor: false,
            highlight: true,
            recordIP: false,
            
            
            
            enableQQ: false,
            requiredFields: [],
        });</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="https://img.byr.cool/i/2024/01/23/65af808bd5f80.webp" alt="Carbene Hu"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Carbene Hu</p><p class="is-size-6 is-block">An ordinary guy</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Beijing, China</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">37</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">25</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">61</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/Hyiker" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/Hyiker"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Zhihu" href="https://www.zhihu.com/people/sidice-24"><i class="fab fa-zhihu"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Academic" href="https://chonghao.carbene.cc"><i class="fas fa-graduation-cap"></i></a></div></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://wadechiang.github.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">WadeChiang</span></span><span class="level-right"><span class="level-item tag">wadechiang.github.io</span></span></a></li><li><a class="level is-mobile" href="https://clslaid.icu/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">CL</span></span><span class="level-right"><span class="level-item tag">clslaid.icu</span></span></a></li><li><a class="level is-mobile" href="https://ayamir.github.io/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Ayamir</span></span><span class="level-right"><span class="level-item tag">ayamir.github.io</span></span></a></li><li><a class="level is-mobile" href="https://leeshy-tech.github.io/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">LeeShy</span></span><span class="level-right"><span class="level-item tag">leeshy-tech.github.io</span></span></a></li><li><a class="level is-mobile" href="https://maxlinn.site/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Maxlinn</span></span><span class="level-right"><span class="level-item tag">maxlinn.site</span></span></a></li></ul></div></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2024/12/"><span class="level-start"><span class="level-item">十二月 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/11/"><span class="level-start"><span class="level-item">十一月 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/10/"><span class="level-start"><span class="level-item">十月 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/02/"><span class="level-start"><span class="level-item">二月 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/12/"><span class="level-start"><span class="level-item">十二月 2023</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/06/"><span class="level-start"><span class="level-item">六月 2023</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/05/"><span class="level-start"><span class="level-item">五月 2023</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/01/"><span class="level-start"><span class="level-item">一月 2023</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/08/"><span class="level-start"><span class="level-item">八月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/07/"><span class="level-start"><span class="level-item">七月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/04/"><span class="level-start"><span class="level-item">四月 2022</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/03/"><span class="level-start"><span class="level-item">三月 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/02/"><span class="level-start"><span class="level-item">二月 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/01/"><span class="level-start"><span class="level-item">一月 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/12/"><span class="level-start"><span class="level-item">十二月 2021</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/11/"><span class="level-start"><span class="level-item">十一月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/09/"><span class="level-start"><span class="level-item">九月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/08/"><span class="level-start"><span class="level-item">八月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/04/"><span class="level-start"><span class="level-item">四月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/03/"><span class="level-start"><span class="level-item">三月 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/01/"><span class="level-start"><span class="level-item">一月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/12/"><span class="level-start"><span class="level-item">十二月 2020</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/07/"><span class="level-start"><span class="level-item">七月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#起因"><span class="level-left"><span class="level-item">起因</span></span></a></li><li><a class="level is-mobile" href="#还在漏还在漏"><span class="level-left"><span class="level-item">还在漏还在漏</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#问题定位"><span class="level-left"><span class="level-item">问题定位</span></span></a></li><li><a class="level is-mobile" href="#漏水容易补水难"><span class="level-left"><span class="level-item">漏水容易补水难</span></span></a></li><li><a class="level is-mobile" href="#解决方案"><span class="level-left"><span class="level-item">解决方案</span></span></a></li></ul></li><li><a class="level is-mobile" href="#gunicorn哈哈没想到吧"><span class="level-left"><span class="level-item">Gunicorn：哈哈，没想到吧</span></span></a></li><li><a class="level is-mobile" href="#省流总结"><span class="level-left"><span class="level-item">省流总结</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img class="logo-img" src="https://s4.ax1x.com/2021/12/30/TR2810.png" alt="甲醛的小屋" height="28"><img class="logo-img-dark" src="https://s1.ax1x.com/2022/04/03/q7u93t.png" alt="甲醛的小屋" height="28"></a><p class="is-size-7"><span>&copy; 2024 Carbene Hu</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Follow me on GitHub" href="https://github.com/Hyiker"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-cn");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/analytics.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/mhchem.min.js" defer></script><script>window.addEventListener("load", function() {
            document.querySelectorAll('[role="article"] > .content').forEach(function(element) {
                renderMathInElement(element);
            });
        });</script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script><script type="text/javascript" src="/js/imaegoo/universe.js"></script></body></html>